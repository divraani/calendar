import 'package:flutter/material.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:intl/intl.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:timezone/data/latest_all.dart' as tz;
import 'package:timezone/timezone.dart' as tz;
import 'package:flutter/foundation.dart' show kIsWeb;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  tz.initializeTimeZones();
  if (!kIsWeb) {
    await NotificationService().init();
  }
  runApp(CalendarApp());
}

class CalendarApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'UCSC Calendar',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: CalendarScreen(),
    );
  }
}

class CalendarScreen extends StatefulWidget {
  @override
  _CalendarScreenState createState() => _CalendarScreenState();
}

class _CalendarScreenState extends State<CalendarScreen> {
  CalendarFormat _calendarFormat = CalendarFormat.month;
  DateTime _selectedDay = DateTime.now();
  DateTime _focusedDay = DateTime.now();

  final TextEditingController _eventController = TextEditingController();
  Map<String, List<String>> _events = {};
  Map<String, List<String>> _activities = {};

  Map<String, Map<String, dynamic>> _assignments = {
    'Math HW1': {
      'deadline': DateTime.now().add(Duration(days: 2)),
      'estimatedHours': 3,
    },
    'CS Project': {
      'deadline': DateTime.now().add(Duration(days: 5)),
      'estimatedHours': 5,
    },
    'Physics Lab': {
      'deadline': DateTime.now().add(Duration(days: 1, hours: 12)),
      'estimatedHours': 2,
    },
  };

  @override
  Widget build(BuildContext context) {
    String selectedDateKey = _selectedDay.toIso8601String().split('T')[0];
    List<String> eventsForDay = _events[selectedDateKey] ?? [];
    List<String> activitiesForDay = _activities[selectedDateKey] ?? [];

    return Scaffold(
      appBar: AppBar(
        title: Text('UCSC Calendar üêå'),
        actions: [
          IconButton(
            icon: Icon(Icons.today),
            onPressed: () {
              setState(() {
                _selectedDay = DateTime.now();
                _focusedDay = DateTime.now();
              });
            },
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        child: Icon(Icons.bar_chart),
        onPressed: () {
          DateTime startOfWeek =
          _focusedDay.subtract(Duration(days: _focusedDay.weekday - 1));
          int totalActivities = 0;
          for (int i = 0; i < 7; i++) {
            String dayKey =
            startOfWeek.add(Duration(days: i)).toIso8601String().split('T')[0];
            totalActivities += _activities[dayKey]?.length ?? 0;
          }
          showDialog(
            context: context,
            builder: (_) => AlertDialog(
              title: Text('Weekly Summary'),
              content: Text('You completed $totalActivities activities this week!'),
              actions: [
                TextButton(
                  child: Text('Close'),
                  onPressed: () => Navigator.pop(context),
                )
              ],
            ),
          );
        },
      ),
      body: Column(
        children: [
          TableCalendar(
            firstDay: DateTime.utc(2020, 1, 1),
            lastDay: DateTime.utc(2030, 12, 31),
            focusedDay: _focusedDay,
            selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
            onDaySelected: (selectedDay, focusedDay) {
              setState(() {
                _selectedDay = selectedDay;
                _focusedDay = focusedDay;
              });
            },
            calendarFormat: _calendarFormat,
            onFormatChanged: (format) {
              setState(() {
                _calendarFormat = format;
              });
            },
            calendarStyle: CalendarStyle(
              todayDecoration: BoxDecoration(
                color: Colors.blue[700],
                shape: BoxShape.circle,
              ),
              selectedDecoration: BoxDecoration(
                color: Colors.yellow[700],
                shape: BoxShape.circle,
              ),
            ),
          ),

          // Event & Activity input
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _eventController,
                    decoration: InputDecoration(
                      labelText: 'Event / Activity',
                      border: OutlineInputBorder(),
                    ),
                  ),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue[700],
                  ),
                  child: Text('Add Event'),
                  onPressed: () async {
                    if (_eventController.text.isEmpty) return;

                    TimeOfDay? pickedTime = await showTimePicker(
                      context: context,
                      initialTime: TimeOfDay.now(),
                    );
                    if (pickedTime == null) return;

                    DateTime eventDateTime = DateTime(
                      _selectedDay.year,
                      _selectedDay.month,
                      _selectedDay.day,
                      pickedTime.hour,
                      pickedTime.minute,
                    );

                    setState(() {
                      _events.putIfAbsent(selectedDateKey, () => []);
                      _events[selectedDateKey]!.add(
                        '${_eventController.text} at ${DateFormat('HH:mm').format(eventDateTime)}',
                      );
                      _eventController.clear();
                    });

                    if (!kIsWeb) {
                      NotificationService().scheduleNotification(
                        id: DateTime.now().millisecondsSinceEpoch ~/ 1000,
                        title: 'Reminder',
                        body: 'Event: ${_eventController.text}',
                        dateTime: eventDateTime,
                      );
                    }
                  },
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.green[700],
                  ),
                  child: Text('Add Activity'),
                  onPressed: () {
                    if (_eventController.text.isEmpty) return;
                    setState(() {
                      _activities.putIfAbsent(selectedDateKey, () => []);
                      _activities[selectedDateKey]!.add(_eventController.text);
                      _eventController.clear();
                    });
                  },
                )
              ],
            ),
          ),

          // Daily Summary
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Text(
              'Daily Summary: ${activitiesForDay.length} activities today',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
          ),

          // Events & Activities List
          Expanded(
            child: ListView(
              children: [
                ...eventsForDay.map((e) => ListTile(
                  title: Text(e),
                  leading: Icon(Icons.event),
                  trailing: IconButton(
                    icon: Icon(Icons.delete, color: Colors.red),
                    onPressed: () {
                      setState(() {
                        _events[selectedDateKey]!.remove(e);
                      });
                    },
                  ),
                )),
                ...activitiesForDay.map((a) => ListTile(
                  title: Text(a),
                  leading: Icon(Icons.check_circle_outline),
                  trailing: IconButton(
                    icon: Icon(Icons.delete, color: Colors.red),
                    onPressed: () {
                      setState(() {
                        _activities[selectedDateKey]!.remove(a);
                      });
                    },
                  ),
                )),
              ],
            ),
          ),

          // Upcoming Deadlines (horizontal)
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Text(
              'Upcoming Deadlines',
              style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF003399)),
            ),
          ),
          Container(
            height: 100,
            child: ListView(
              scrollDirection: Axis.horizontal,
              children: _assignments.entries.map((entry) {
                String name = entry.key;
                DateTime deadline = entry.value['deadline'];
                int estHours = entry.value['estimatedHours'];

                DateTime suggestedStart = deadline.subtract(Duration(hours: estHours));
                bool overdue = DateTime.now().isAfter(deadline);

                return Container(
                  width: 160,
                  margin: EdgeInsets.only(right: 8),
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: overdue ? Colors.red[200] : Colors.blue[100],
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(color: Colors.blueAccent),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(name,
                          style: TextStyle(fontWeight: FontWeight.bold),
                          overflow: TextOverflow.ellipsis),
                      SizedBox(height: 4),
                      Text('Deadline: ${DateFormat('MM/dd').format(deadline)}'),
                      Text('Start by: ${DateFormat('MM/dd HH:mm').format(suggestedStart)}'),
                    ],
                  ),
                );
              }).toList(),
            ),
          ),
        ],
      ),
    );
  }
}

/// Notification service class
class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;
  NotificationService._internal();

  final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
  FlutterLocalNotificationsPlugin();

  Future<void> init() async {
    const AndroidInitializationSettings initializationSettingsAndroid =
    AndroidInitializationSettings('@mipmap/ic_launcher');

    const InitializationSettings initializationSettings =
    InitializationSettings(android: initializationSettingsAndroid);

    await flutterLocalNotificationsPlugin.initialize(initializationSettings);
  }

  Future<void> scheduleNotification({
    required int id,
    required String title,
    required String body,
    required DateTime dateTime,
  }) async {
    await flutterLocalNotificationsPlugin.zonedSchedule(
      id,
      title,
      body,
      tz.TZDateTime.from(dateTime, tz.local),
      const NotificationDetails(
        android: AndroidNotificationDetails(
          'reminder_channel',
          'Reminders',
          'Channel for calendar reminders',
          importance: Importance.max,
          priority: Priority.high,
        ),
      ),
      androidAllowWhileIdle: true,
      uiLocalNotificationDateInterpretation:
      UILocalNotificationDateInterpretation.absoluteTime,
    );
  }
}
