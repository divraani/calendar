import 'package:flutter/material.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:intl/intl.dart';

void main() {
  runApp(CalendarApp());
}

class CalendarApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'UCSC Calendar',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: CalendarScreen(),
    );
  }
}

class CalendarScreen extends StatefulWidget {
  @override
  _CalendarScreenState createState() => _CalendarScreenState();
}

class _CalendarScreenState extends State<CalendarScreen> {
  CalendarFormat _calendarFormat = CalendarFormat.month;
  DateTime _selectedDay = DateTime.now();
  DateTime _focusedDay = DateTime.now();

  final TextEditingController _eventController = TextEditingController();
  Map<String, List<String>> _events = {};

  // Example assignments (Canvas-style)
  Map<String, Map<String, dynamic>> _assignments = {
    'Math HW1': {
      'deadline': DateTime.now().add(Duration(days: 2)),
      'estimatedHours': 3,
    },
    'CS Project': {
      'deadline': DateTime.now().add(Duration(days: 5)),
      'estimatedHours': 5,
    },
    'Physics Lab': {
      'deadline': DateTime.now().add(Duration(days: 1, hours: 12)),
      'estimatedHours': 2,
    },
  };

  @override
  Widget build(BuildContext context) {
    String selectedDateKey = _selectedDay.toIso8601String().split('T')[0];
    List<String> eventsForDay = _events[selectedDateKey] ?? [];

    return Scaffold(
      appBar: AppBar(
        title: Text('UCSC Calendar 🐌'),
        actions: [
          IconButton(
            icon: Icon(Icons.today),
            onPressed: () {
              setState(() {
                _selectedDay = DateTime.now();
                _focusedDay = DateTime.now();
              });
            },
          ),
        ],
      ),
      body: Column(
        children: [
          // Calendar
          TableCalendar(
            firstDay: DateTime.utc(2020, 1, 1),
            lastDay: DateTime.utc(2030, 12, 31),
            focusedDay: _focusedDay,
            selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
            onDaySelected: (selectedDay, focusedDay) {
              setState(() {
                _selectedDay = selectedDay;
                _focusedDay = focusedDay;
              });
            },
            calendarFormat: _calendarFormat,
            onFormatChanged: (format) {
              setState(() {
                _calendarFormat = format;
              });
            },
            calendarStyle: CalendarStyle(
              todayDecoration: BoxDecoration(
                color: Colors.blue[700],
                shape: BoxShape.circle,
              ),
              selectedDecoration: BoxDecoration(
                color: Colors.yellow[700],
                shape: BoxShape.circle,
              ),
            ),
          ),

          // Event input
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _eventController,
                    decoration: InputDecoration(
                      labelText: 'Event',
                      border: OutlineInputBorder(),
                    ),
                  ),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue[700],
                  ),
                  child: Text('Add'),
                  onPressed: () {
                    if (_eventController.text.isEmpty) return;
                    setState(() {
                      _events.putIfAbsent(selectedDateKey, () => []);
                      _events[selectedDateKey]!.add(_eventController.text);
                      _eventController.clear();
                    });
                  },
                )
              ],
            ),
          ),

          // Events List
          Expanded(
            child: ListView.builder(
              itemCount: eventsForDay.length,
              itemBuilder: (context, index) {
                return ListTile(
                  title: Text(eventsForDay[index]),
                  trailing: IconButton(
                    icon: Icon(Icons.delete, color: Colors.red),
                    onPressed: () {
                      setState(() {
                        _events[selectedDateKey]!.removeAt(index);
                      });
                    },
                  ),
                );
              },
            ),
          ),

          // Upcoming Deadlines
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Text(
              'Upcoming Deadlines',
              style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF003399)),
            ),
          ),
          Container(
            height: 100,
            child: ListView(
              scrollDirection: Axis.horizontal,
              children: _assignments.entries.map((entry) {
                String name = entry.key;
                DateTime deadline = entry.value['deadline'];
                int estHours = entry.value['estimatedHours'];

                // Calculate suggested start date
                DateTime suggestedStart = deadline.subtract(Duration(hours: estHours));

                bool overdue = DateTime.now().isAfter(deadline);

                return Container(
                  width: 160,
                  margin: EdgeInsets.only(right: 8),
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: overdue ? Colors.red[200] : Colors.blue[100],
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(color: Colors.blueAccent),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(name,
                          style: TextStyle(fontWeight: FontWeight.bold),
                          overflow: TextOverflow.ellipsis),
                      SizedBox(height: 4),
                      Text('Deadline: ${DateFormat('MM/dd').format(deadline)}'),
                      Text('Start by: ${DateFormat('MM/dd HH:mm').format(suggestedStart)}'),
                    ],
                  ),
                );
              }).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
